---
# === 1. Подготовка каталогов ===
- name: Ensure install directory exists
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}"
    state: directory
    mode: '0755'

- name: Ensure required directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ nexus_install_dir }}/nexus-data"
    - "{{ nexus_install_dir }}/nexus-nginx-data"

# === 2. Скопировать конфигурационные файлы ===
- name: Copy nginx.conf and docker-compose.yml
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: "nginx.conf", dest: "{{ nexus_install_dir }}/nginx.conf" }
    - { src: "docker-compose.yml", dest: "{{ nexus_install_dir }}/docker-compose.yml" }

# === 3. Запустить контейнеры ===
- name: Start Nexus and Nginx via docker-compose
  community.docker.docker_compose_v2:
    project_src: "{{ nexus_install_dir }}"
    state: present

# === 4. Ждать готовности Nexus REST API ===
- name: Wait for Nexus REST API to be ready
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/status"
    method: GET
    validate_certs: "{{ ssl_validate }}"
    timeout: 10
  register: nexus_health
  until:
    - nexus_health.status is defined
    - nexus_health.status == 200
  retries: 120
  delay: 5

# === 5. Ждать появления admin.password (Nexus генерирует при первом старте) ===
- name: Wait for Nexus to generate admin.password
  ansible.builtin.stat:
    path: "{{ nexus_install_dir }}/nexus-data/admin.password"
  register: admin_password_file
  until: admin_password_file.stat.exists
  retries: 60
  delay: 3

# === 6. Прочитать начальный пароль, сгенерированный Nexus ===
- name: Read initial admin password generated by Nexus
  ansible.builtin.slurp:
    src: "{{ nexus_install_dir }}/nexus-data/admin.password"
  register: initial_password_raw
  no_log: true

- name: Set initial password fact
  ansible.builtin.set_fact:
    nexus_initial_password: "{{ initial_password_raw.content | b64decode | trim }}"
  no_log: true

# === 7. Сменить пароль admin через Nexus API ===
- name: Change admin password from initial to target
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/security/users/admin/change-password"
    method: PUT
    user: "{{ nexus_user }}"
    password: "{{ nexus_initial_password }}"
    force_basic_auth: true
    validate_certs: "{{ ssl_validate }}"
    headers:
      Content-Type: "text/plain"
    body: "{{ nexus_password }}"
    status_code: [204]
  no_log: true
  changed_when: true

# === 8. Удалить admin.password (безопасность) ===
- name: Remove admin.password after password change
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}/nexus-data/admin.password"
    state: absent

# === 9. Включить анонимный доступ ===
- name: Ensure anonymous access is enabled
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/security/anonymous"
    method: PUT
    user: "{{ nexus_user }}"
    password: "{{ nexus_password }}"
    force_basic_auth: true
    validate_certs: "{{ ssl_validate }}"
    status_code: [200, 204]
    body_format: json
    body:
      enabled: true
      userId: "anonymous"
      realmName: "NexusAuthorizingRealm"
    headers:
      Content-Type: application/json
  no_log: true
  changed_when: false
