---
# === 1. Подготовка каталогов ===
- name: Ensure install directory exists
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}"
    state: directory
    mode: '0755'

- name: Ensure required directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ nexus_install_dir }}/nexus-data"
    - "{{ nexus_install_dir }}/nexus-nginx-data"

# === 2. Создать admin.password ДО запуска контейнера ===
- name: Create admin.password for initial setup
  ansible.builtin.copy:
    content: "{{ nexus_password }}"
    dest: "{{ nexus_install_dir }}/nexus-data/admin.password"
    mode: '0600'
  no_log: true

- name: Copy nginx.conf and docker-compose.yml
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0644'
  loop:
    - { src: "nginx.conf", dest: "{{ nexus_install_dir }}/nginx.conf" }
    - { src: "docker-compose.yml", dest: "{{ nexus_install_dir }}/docker-compose.yml" }

# === 3. Запустить контейнеры ===
- name: Start Nexus and Nginx via docker-compose
  community.docker.docker_compose_v2:
    project_src: "{{ nexus_install_dir }}"
    state: present

# === 4. Ждать готовности ===
- name: Wait for Nexus to respond (200 or 401)
  ansible.builtin.uri:
    url: "{{ nexus_url }}"
    method: GET
    validate_certs: false
    timeout: 10
  register: nexus_health
  until:
    - nexus_health.status is defined
    - nexus_health.status == 200 or nexus_health.status == 401
  retries: 120
  delay: 5
  ignore_errors: true

# === 5. Удалить admin.password (безопасность) ===
- name: Remove admin.password after first start
  ansible.builtin.file:
    path: "{{ nexus_install_dir }}/nexus-data/admin.password"
    state: absent

# === 6. Включить анонимный доступ ===
- name: Ensure anonymous access is enabled
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/security/anonymous"
    method: PUT
    user: admin
    password: "{{ nexus_password }}"
    force_basic_auth: true
    validate_certs: "{{ ssl_validate }}"
    status_code: [200, 204]
    body_format: json
    body:
      enabled: true
      userId: "anonymous"
      realmName: "NexusAuthorizingRealm"
    headers:
      Content-Type: application/json
  no_log: true
  changed_when: false
