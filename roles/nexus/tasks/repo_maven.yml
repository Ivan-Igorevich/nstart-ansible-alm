# roles/nexus/tasks/maven.yml
---
- name: Get existing Maven repositories
  uri:
    url: "{{ nexus_url }}/service/rest/v1/repositories"
    method: GET
    user: "{{ nexus_user }}"
    password: "{{ nexus_password }}"
    force_basic_auth: yes
    validate_certs: "{{ ssl_validate }}"
    return_content: yes
  register: existing_repos
  changed_when: false

- name: Extract Maven repositories from library
  set_fact:
    maven_repos: >-
      {{
        nexus_active_repositories
        | map('extract', nexus_repository_library)
        | selectattr('format', '==', 'maven')
        | list
      }}

# --- Hosted ---
- name: Create Maven hosted repository
  uri:
    url: "{{ nexus_url }}/service/rest/v1/repositories/maven/hosted"
    method: POST
    user: "{{ nexus_user }}"
    password: "{{ nexus_password }}"
    force_basic_auth: yes
    validate_certs: "{{ ssl_validate }}"
    status_code: 201,204,400
    body_format: json
    body:
      name: "{{ item.name }}"
      online: true
      storage:
        blobStoreName: "{{ item.blob_store }}"
        strictContentTypeValidation: true
      cleanup: { policyNames: [] }
      writePolicy: "ALLOW"
      component: { proprietaryComponents: false }
      maven:
        versionPolicy: "RELEASE"
        layoutPolicy: "STRICT"
    headers:
      Content-Type: application/json
  loop: "{{ maven_repos | selectattr('type', '==', 'hosted') | list }}"
  vars:
    existing_names: "{{ existing_repos.json | map(attribute='name') | list | default([]) }}"
  when: item.name not in existing_names
  changed_when: false
  tags: [configure, maven]

# --- Proxy ---
- name: Create Maven proxy repository
  uri:
    url: "{{ nexus_url }}/service/rest/v1/repositories/maven/proxy"
    method: POST
    user: "{{ nexus_user }}"
    password: "{{ nexus_password }}"
    force_basic_auth: yes
    validate_certs: "{{ ssl_validate }}"
    status_code: 201,204,400
    body_format: json
    body:
      name: "{{ item.name }}"
      online: true
      storage:
        blobStoreName: "{{ item.blob_store }}"
        strictContentTypeValidation: true
      cleanup: { policyNames: [] }
      proxy:
        remoteUrl: "{{ item.remote_url }}"
        contentMaxAge: 1440
        metadataMaxAge: 1440
      negativeCache:
        enabled: true
        timeToLive: 1440
      httpClient:
        autoBlock: true
        blocked: false
      maven:
        versionPolicy: "MIXED"
        layoutPolicy: "{{ item.maven_layout_policy | default('STRICT') }}"
    headers:
      Content-Type: application/json
  loop: "{{ maven_repos | selectattr('type', '==', 'proxy') | list }}"
  vars:
    existing_names: "{{ existing_repos.json | map(attribute='name') | list | default([]) }}"
  when: item.name not in existing_names
  changed_when: false
  tags: [configure, maven]

# --- Group ---
- name: Create Maven group repository
  uri:
    url: "{{ nexus_url }}/service/rest/v1/repositories/maven/group"
    method: POST
    user: "{{ nexus_user }}"
    password: "{{ nexus_password }}"
    force_basic_auth: yes
    validate_certs: "{{ ssl_validate }}"
    status_code: 201,204,400
    body_format: json
    body:
      name: "{{ item.name }}"
      online: true
      storage:
        blobStoreName: "{{ item.blob_store }}"
        strictContentTypeValidation: true
      group:
        memberNames: "{{ item.member_names }}"
    headers:
      Content-Type: application/json
  loop: "{{ maven_repos | selectattr('type', '==', 'group') | list }}"
  vars:
    existing_names: "{{ existing_repos.json | map(attribute='name') | list | default([]) }}"
  when: item.name not in existing_names
  changed_when: false
  tags: [configure, maven]
